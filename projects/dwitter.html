<!DOCTYPE html>
    <head>
		<script async src = "https://www.googletagmanager.com/gtag/js?id=G-W2C6ZR2P0X"></script>
        <link rel = stylesheet type = text/css href = "https://fonts.googleapis.com/css?family=Nunito">
        <script src = https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js type = application/javascript charset = utf-8></script>
        <script src = https://kit.fontawesome.com/1dc9aa0b49.js crossorigin = anonymous></script>
        <script src = ../js/analytics.js></script>
        <meta charset = utf-8>

        <title>Dweet Runner</title>

        <style>
            html {
                height: 100%;
            }

            body {
                font-family: Consolas, Menlo, Courier, monospace;
                font-weight: 900;
                overflow: hidden;
                height: 100%;
                margin: 2rem;
                display: flex;
                flex-flow: row;
            }

            #left {
                flex: 0 0 auto;
                height: -moz-calc(100% - 4rem);
                height: -webkit-calc(100% - 4rem);
                height: -o-calc(100% - 4rem);
                height: calc(100% - 4rem);
                padding-right: 1rem;
            }

            #right {
                flex: auto;
                height: -moz-calc(100% - 4rem);
                height: -webkit-calc(100% - 4rem);
                height: -o-calc(100% - 4rem);
                height: calc(100% - 4rem);
            }

            #error {
                width: -moz-calc(100% - 2rem);
                width: -webkit-calc(100% - 2rem);
                width: -o-calc(100% - 2rem);
                width: calc(100% - 2rem);
                height: 6rem;
                float: right;
                border: none;
                border-radius: 0.4rem;
                margin-top: 1rem;
                padding: 0.5rem;
                overflow: auto;
            }

            #text {
                height: -moz-calc(100% - 3.5rem);
                height: -webkit-calc(100% - 3.5rem);
                height: -o-calc(100% - 3.5rem);
                height: calc(100% - 3.5rem);
                resize: horizontal;
                border: none;
                border-radius: 0.4rem;
                padding: 0.5rem;
                margin-bottom: 0.5rem;
                overflow: auto;
                font-size: 1.3rem;
                width: 60vw;
            }

            canvas {
                border-radius: 0.4rem;
                margin-left: 0.8rem;
                margin-top: 0.8rem;
                height: 2.5rem;
                width: 10rem;
                float: left;
            }

            span {
                font-size: 1.3rem;
                height: 2rem;
            }

            iframe {
                width: -moz-calc(100% - 1rem);
                width: -webkit-calc(100% - 1rem);
                width: -o-calc(100% - 1rem);
                width: calc(100% - 1rem);
                float: right;
                border: none;
                border-radius: 0.4rem;
                overflow: hidden;
                padding: 0;
                margin: 0;
            }

            button, select {
                font-family: Nunito;
                font-weight: bold;
                border: none;
                height: 2.5rem;
                border-radius: 0.4rem;
                font-size: 1rem;
                margin-left: 1rem;
                margin-top: 0.8rem;
                padding-left: 0.8rem;
                padding-right: 0.8rem;
                float: left;
                -webkit-appearance: none;
            }

            footer {
                position: absolute;
                bottom: 0;
                color: #888;
            }

            footer a {
                color: #fff;
                text-decoration: none;
            }

            footer a:hover {
                color: #888;
                text-decoration: none;
            }
        </style>
    </head>

    <body>
        <div id = left>
            <div id = text></div>
            <span id = count></span>
            <footer id = footer></footer>
        </div>

        <div id = right>
            <iframe id = frame></iframe>
            <button title = "Restart the dweet" onClick = input()><i class = "fas fa-step-backward"></i></button>
            <button id = button title = "Pause or resume" onClick = play()><i class = "fas fa-pause"></i></button>
            <canvas id = bar></canvas>
            <div id = error></div>
            <button title = "Reset the whole page" onClick = reset()><i class = "fas fa-sync-alt"></i> Reset</button>
            <button title = "Apply unicode compression" onClick = compress()><i class = "fas fa-compress-alt"></i> Compress</button>
            <button title = "Uncompress your dweet" onClick = unpack()><i class = "fas fa-expand-alt"></i> Unpack</button>
            <button title = "View dweet in fullscreen mode" onClick = fullscreen()><i class = "fas fa-expand"></i> Fullscreen</button>
            <select title = "Change color theme" id = select onchange = change()>
                <option>Dark</option>
                <option>Mid</option>
                <option>Light</option>
                <option>Navy</option>
                <option>Girly</option>
                <option>Alien</option>
                <option>Mad</option>
            </select>
        </div>

        <script>
            const resize = event => frame.style.height = (frame.clientWidth * 9 / 16) + "px"
            const base = "c.width=1920\nfor(i=0;i<9;i++)\nx.fillRect(400+i*100+S(t)*300,400,50,200)"
            const timeout = 1000
            const speed = []
            const context = bar.getContext("2d")
            const editor = ace.edit(text)

            const colors = {
                Dark: {main: "#333", box: "#666", error: "#f33", text: "#fff", button: "#555", hover: "#777", bar: "#aaa", theme: "merbivore"},
                Mid: {main: "#666", box: "#aaa", error: "#f00", text: "#000", button: "#999", hover: "#ccc", bar: "#ddd", theme: "tomorrow_night_eighties"},
                Light: {main: "#aaa", box: "#ddd", error: "#d22", text: "#333", button: "#ccc", hover: "#fff", bar: "#fff", theme: "tomorrow"},
                Navy: {main: "#337", box: "#668", error: "#f00", text: "#fff", button: "#558", hover: "#99a", bar: "#aab", theme: "tomorrow_night_blue"},
                Girly: {main: "#b9b", box: "#767", error: "#f45", text: "#fef", button: "#858", hover: "#979", bar: "#ede", theme: "katzenmilch"},
                Alien: {main: "#444", box: "#666", error: "#f00", text: "#5f5", button: "#575", hover: "#555", bar: "#4e4", theme: "gob"},
                Mad: {main: "#08f", box: "#0ff", error: "#f00", text: "#f0f", button: "#ff0", hover: "#0f0", bar: "#f00", theme: "cobalt"}
            }

            const start = () => {
                frame.sandbox.add("allow-scripts")
                frame.sandbox.add("allow-same-origin")

                editor.setTheme("ace/theme/eclipse")
                editor.session.setMode("ace/mode/javascript")
                editor.setValue(localStorage.getItem("code") || base)
                editor.on("change", event => input())

                window.onerror = message => print(message, "error")
                window.store = 0
                window.theme = null
                window.clock = 0
                window.paused = false
                window.content = frame.contentWindow || frame.contentDocument
                bar.width = bar.height = 1000
                footer.innerHTML = `\u00a9 <a href=https://greyhope.uk target=_blank>GreyHope</a> ${new Date().getFullYear()}
                ~ Inspired by the <a href=http://dweetabase.3d2k.com target=_blank>Dweetabase</a> by Frank Force.`

                addEventListener("resize", resize)
                let thing = new ResizeObserver(resize)
                thing.observe(text)

                change()
                input()
                requestAnimationFrame(loop)
            }

            const input = () => {
                refresh()

                const wrap = code => {
                    return code.replace(/(for\s*\([^;]*;[^;]*;|while\s*\()\s*(\S)/g, (a, b, c) => 
                        b && c && !b.match(/\sof\s|\sin\s/g) ? 
                        b + "((++count&40)<1&&timeout<Date.now())&&(error=>{throw new Error('Timed out')})()" +
                        (c == ')' ? '' : ',') + c : a)
                }

                try {
                    content.eval("function u(t) {" + wrap(editor.getValue()) + "}")
                    //here
                }

                catch (message) {
                    print(message, "error")
                    content.u = t => {}
                }

                content.window.u = content.u
                localStorage.setItem("code", editor.getValue())
                store = 0

                number()
            }

            const number = () => {
                let length = 0
                for (let char of editor.getValue()) length += 1
                count.innerHTML = "Characters: " + length
                count.style.color = length > 140 ? colors[theme].error : colors[theme].text
            }

            const print = (message, type) => {
                let html = "<span style='color:" + colors[theme][type] + "'>" + message + "</span><br>"
                error.innerHTML += html
                if (error.innerHTML.length > 5000) error.innerHTML = ""
                error.scrollTop = error.scrollHeight
            }

            const refresh = () => {
                let iframe = document.createElement('iframe')
                frame.before(iframe)
                frame.remove()
                frame = iframe
                content = frame.contentWindow || frame.contentDocument    
                content.document.open()
                content.document.write("<body style='margin:0;overflow:hidden'><canvas width=1920 height=1080 id=c style='background:#fff;width:100%'>")
                content.document.close()
                content.count = 0
                content.timeout = 0
                content.x = content.c.getContext("2d")
                content.S = content.Math.sin
                content.C = content.Math.cos
                content.T = content.Math.tan
                content.R = (r, g, b, a) => `rgba(${r|0},${g|0},${b|0},${a===undefined?1:a})`
                content.console.log = message => print(message, "text")
                error.innerHTML = ""
                speed.length = 0
                resize()
            }

            const unpack = () => {
                let code = editor.getValue()
                let index = code.toLowerCase().search(/eval\(unescape\(escape`/g)
                
                if (index >= 0) {
                    const start = code.slice(0, index)
                    const end = code.slice(index)
                    const result = content.eval(end.slice(4))

                    if (result) {
                        code = start + result
                        editor.setValue(code)
                    }
                }
                
                input()
            }

            const loop = rate => {
                requestAnimationFrame(loop)

                if (paused) {
                    clock = rate
                    return
                }

                let width = 10
                let time = 1000 / (rate - clock)
                let last = bar.width - speed.length * width

                bar.width = bar.width
                speed.push(time * 10)

                context.fillStyle = colors[theme].bar
                context.moveTo(last, bar.height)
                speed.forEach((item, index) => context.lineTo(last + index * width, bar.height - item))
                context.lineTo(bar.width, bar.height)
                context.fill()

                speed.length > bar.width / width && speed.shift()
                content.count = 0
                content.timeout = Date.now() + timeout

                try {content.window.u(store)}
                catch (message) {print(message, "error")}

                store += (rate - clock) / 1000
                clock = rate
            }

            const play = () => {
                paused = !paused
                button.innerHTML = "<i class = 'fas fa-" + (paused ? "play" : "pause") + "'></i>"
            }

            const reset = () => {
                if (!confirm("Do you really want to reset everything?")) return
                editor.setValue(base)
                input()
            }

            const change = () => {
                let buttons = document.getElementsByTagName("button")
                let tags = document.getElementsByTagName("select")
                tags = [...buttons, ...tags]

                theme = select.value
                document.body.style.background = colors[theme].main
                error.style.background = colors[theme].box
                bar.style.background = colors[theme].button
                editor.setTheme("ace/theme/" + colors[theme].theme)

                for (let item of tags) {
                    item.style.background = colors[theme].button
                    item.style.color = colors[theme].text
                    item.addEventListener("mouseover", () => item.style.background = colors[theme].hover)
                    item.addEventListener("mouseout", () => item.style.background = colors[theme].button)
                }

                number()
            }

            const compress = () => {
                const value = [...editor.getValue().trim()]
                let code = ""

                for (let character of value) {
                    const char = character.charCodeAt(0)
                    if (char > 255) character = escape(character).replace(/%u/g,'\\u')
                    code += character
                }

                let compressed = String.fromCharCode(...[...code.length % 2 ? code + ";" : code].map((item, index) => item.charCodeAt() | (index % 2 ? 0xDF00 : 0xDB00)))
                compressed = "eval(unescape(escape`" + compressed + "`.replace(/u../g,'')))"

                editor.setValue(compressed)
                input()
            }

            const fullscreen = () => {
                if (frame.webkitRequestFullScreen) frame.webkitRequestFullScreen()
                else frame.mozRequestFullScreen()
            }

            start()
        </script>
    </body>
</html>